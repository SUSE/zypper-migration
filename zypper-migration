#!/usr/bin/ruby

require 'optparse'
require "suse/connect"

options = {
    :allow-vendor-change => false,
    :verbose => false,
    :quiet => false,
    :non_interactive => false,
    :query => false,
    :migration => 0,
    :repo => [],
    :from => [],
    :auto_agree => false,
    :debug_solver => false,
    :recommends => true,
    :replacefiles => false,
    :details => false,
    :download => nil
}

OptionParser.new do |opts|
  opts.banner = "Usage: zypper migration [options]"

  opts.on("-v", "--[no-]allow-vendor-change", "Allow vendor change") do |v|
    options[:allow-vendor-change] = v
  end

  opts.on("-v", "--[no-]verbose", "Increase verbosity") do |v|
    options[:verbose] = v
  end

  opts.on("-q", "--[no-]quiet", "Suppress normal output, print only error messages") do |q|
    options[:quiet] = q
  end

  opts.on("-n", "--non-interactive", "Do not ask anything, use default answers automatically") do |n|
    options[:non_interactive] = n
  end

  opts.on("--query", "Query available migration options and exit") do |q|
    options[:query] = q
  end

  opts.on("--migration N", OptionParser::DecimalInteger, "Select migration option N") do |n|
    options[:migration] = n
  end

  opts.on("--from REPO", "Restrict upgrade to specified repository") do |r|
    options[:from] << r
  end

  opts.on("-r", "--repo REPO", "Load only the specified repository") do |r|
    options[:repo] << r
  end

  opts.on("-l", "--auto-agree-with-licenses", "Automatically say 'yes' to third party license confirmation prompt") do |a|
    options[:auto_agree] = a
  end

  opts.on("--debug-solver", "Create solver test case for debugging") do |a|
    options[:debug_solver] = a
  end

  opts.on("--[no-]recommends", "Install also recommended packages") do |a|
    options[:recommends] = a
  end

  opts.on("--replacefiles", "Install the packages even if they replace files from other packages") do |a|
    options[:replacefiles] = a
  end

  opts.on("--details", "Show the detailed installation summary") do |a|
    options[:details] = a
  end

  opts.on("--download MODE", ["only", "in-advance", "in-heaps", "as-needed"],"Set the download-install mode") do |a|
    options[:download] = a
  end

  opts.on("--download-only", "Only download the packages, do not install") do |d|
    options[:download] = "only" if d
  end

end.parse!


zypper_product = SUSE::Connect::Zypper::installed_products

if options[:verbose]
  print "Installed products:\n"
  zypper_product.each {|p|
    printf "  %-25s %s\n", "#{p.identifier}/#{p.version}/#{p.arch}", p.summary
  }
  print "\n"
end

connect_products = zypper_product.map {|p| SUSE::Connect::Remote::Product.new(
    :arch => p.arch,
    :identifier => p.identifier,
    :version => p.version,
    :release_type => p.release_type
) }

migrations = SUSE::Connect::YaST.system_migrations connect_products

if migrations.length == 0
  print "No migration available\n\n" unless options[:quiet]
  exit 0
end

migration_num = options[:migration]
if options[:non_interactive] && migration_num == 0
  # select the first option
  migration_num = 1
end


while migration_num <= 0 || migration_num > migrations.length do 
  print "Available migrations:\n\n"
  migrations.each_with_index do |migration, index|
    printf "   %2d |", index + 1
    migration.each do |p|
      print " #{p.identifier}/#{p.version}/#{p.arch}"
    end
    print "\n"
  end
  print "\n"
  if options[:query]
    exit 0
  end
  while migration_num <= 0 || migration_num > migrations.length do
    print "(num/q):"
    choice = gets.chomp 
    exit 0 if choice.eql? "q"
    migration_num = choice.to_i
  end
end

migration = migrations[migration_num - 1]

cmd = "zypper " +
      (options[:non_interactive] ? "--non-interactive " : "") +
      (options[:verbose] ? "--verbose " : "") +
      (options[:quiet] ? "--quiet " : "") +
      " refresh"
print "\nExecuting '#{cmd}'\n\n" unless options[:quiet]
exit 1 unless system cmd

cmd = "zypper " +
      (options[:non_interactive] ? "--non-interactive " : "") +
      (options[:verbose] ? "--verbose " : "") +
      (options[:quiet] ? "--quiet " : "") +
      " update"
print "\nExecuting '#{cmd}'\n\n" unless options[:quiet]
exit 1 unless system cmd

migration.each do |p|
  print "Upgrading product #{p.identifier}/#{p.version}/#{p.arch}\n" unless options[:quiet]
  service = SUSE::Connect::YaST.upgrade_product p

  if service[:obsoleted_service_name]
    print "Removing service #{service[:obsoleted_service_name]}\n" if options[:verbose]
    SUSE::Connect::Zypper::remove_service service[:obsoleted_service_name]
  end

  print "Adding service #{service[:name]}\n" if options[:verbose]
  SUSE::Connect::System::add_service service

end

cmd = "zypper " +
      (options[:allow-vendor-change] ? "--allow-vendor-change " : "--no-allow-vendor-change ") +
      (options[:non_interactive] ? "--non-interactive " : "") +
      (options[:verbose] ? "--verbose " : "") +
      (options[:quiet] ? "--quiet " : "") +
      (options[:auto_agree] ? "--auto-agree-with-licenses " : "") +
      (options[:debug_solver] ? "--debug-solver " : "") +
      (options[:recommends] ? "--recommends " : "--no-recommends ") +
      (options[:replacefiles] ? "--replacefiles " : "") +
      (options[:details] ? "--details " : "") +
      (options[:download] ? "--download #{options[:download]} " : "") +
      (options[:repo].map { |r| "--repo #{r}" }.join(" ")) +
      (options[:from].map { |r| "--from #{r}" }.join(" ")) +
      " dist-upgrade"
print "\nExecuting '#{cmd}'\n\n" unless options[:quiet]
exit 1 unless system cmd


